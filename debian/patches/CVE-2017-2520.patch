Description: Ensure that the sqlite3_value_text() interface returns a buffer that is long enough to hold the complete string plus the zero terminator even when the input is a zeroblob. Fix for a problem detected by OSS-Fuzz.
Origin: https://www.sqlite.org/src/info/2dc7eeb5b4d2eaf
Bug-Debian: 867618 893195
diff --git a/src/vdbemem.c b/src/vdbemem.c
index 6fb7ceb..c5e1228 100644
--- a/src/vdbemem.c
+++ b/src/vdbemem.c
@@ -1025,6 +1025,7 @@ static SQLITE_NOINLINE const void *valueToText(sqlite3_value* pVal, u8 enc){
   assert( (pVal->flags & MEM_RowSet)==0 );
   assert( (pVal->flags & (MEM_Null))==0 );
   if( pVal->flags & (MEM_Blob|MEM_Str) ){
+    if( ExpandBlob(pVal) ) return 0;
     pVal->flags |= MEM_Str;
     if( pVal->flags & MEM_Zero ){
       sqlite3VdbeMemExpandBlob(pVal);
